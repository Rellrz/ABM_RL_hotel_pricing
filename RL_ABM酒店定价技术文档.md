
# 1.ABM部分

## 1.1 消费者画像构建

系统将消费者定义为具有独立属性和决策逻辑的智能体 (Customer Agent)。

1. 客户分层体系

基于数据集中的 `market_segment` 字段，将市场划分为两类典型群体：

 **Type A：传统/忠诚型消费者 (Traditional/Loyal)**
- **数据映射**：对应 CSV 中的 `'Direct'` (直销)，'Corporate'` (协议客)。
- **群体占比**：约 **20%** (基于数据集统计)。
- **行为特征**：
    - **渠道粘性**：**极高**。只浏览酒店官网或前台，不使用 OTA App。
    - **价格敏感度**：**中等**。只要直销价低于心理价位 (WTP) 即下单，不进行全网比价。
    - **支付意愿 (WTP)**：较高。

**Type B：数字/价格敏感型消费者 (Digital/Price-Sensitive)**
- **数据映射**：对应 CSV 中的 `'TA/TO'` 。
- **群体占比**：约 **80%**。
- **行为特征**：
    - **渠道粘性**：**低**。默认首选 OTA（因为习惯/积分/流量入口），但会因为价格差异回流直销。
    - **价格敏感度**：**高**。会同时对比 Pdir​ 和 Pota​，追求性价比。
    - **支付意愿 (WTP)**：略低。

## 1.2客户生成模块

这是体现“佣金博弈”的关键模块。流量到达率 λ 不再是静态常数，而是受酒店决策（佣金档位）影响的变量。
1. 基础到达率 (λbase​)
	- **计算**：按 CSV 中的 `arrival_date_month` 统计每月的日均订单量。
	- **公式**：λbase​(m)=Days in Month mTotal Orders in Month m​
2. 佣金驱动的流量加权 (Traffic Boosting)
	OTA 根据酒店支付的佣金比例调整曝光权重（Ranking Algorithm）。
	- **输入**：酒店 Agent 针对 TargetDate 选择的佣金档位 Tiercomm​∈{0,1,2}。
    - **流量放大系数 (Boost)**：
	    - **Tier 0 (标准 10%)**：Boost=1.0 (基准流量)
	    - **Tier 1 (优选 15%)**：Boost=1.1 (流量增加 10%)
	    - **Tier 2 (战略 20%)**：Boost=1.2 (流量增加 20%)
        

3. 最终流量生成公式

在仿真日 t，生成入住日为 t+k 的潜在客户数量 Narrival​：
1. **Type A 流量 (不受佣金影响)**：
    $N_{TypeA}​∼Poisson(λ_{base}​×40\%)$
    
2. **Type B 流量 (受佣金显著影响)**：
    $N_{TypeB}​∼Poisson(λ_{base}​×60\%×Boost(Tiercomm​))$

> **逻辑推导**：如果酒店为了省钱选了 Tier 0，Type B 的流量会变少；如果选了 Tier 2，虽然单笔赚得少，但 NTypeB​ 会暴增，可能带来更高的总收益。

第二步：赋予个体微观特征向量 ($x_i$)

对于生成的每一个消费者 $i (i=1,…,N_t​)$，我们需要采样生成一个特征向量$x_i$​。这个向量包含四个核心维度，用于后续的效用计算。

**特征向量定义**： $x_i​=[CustomerType_i,LeadTime_i ​,TargetDate_i​ ,WTP_i ​,Sensitivity_i​]$

1. **提前预订期 (Lead Time, $L_i$​)**
    -    - **定义**：预订日期与入住日期的间隔天数 (Tstay​−Tbook​)。
    - **分布模型**：**对数正态分布 (Log-Normal Distribution)**。
    - **参数来源**：拟合 `hotel_bookings.csv` 中的 `lead_time` 列。
    - **生成逻辑**：$LeadTime∼Lognormal(μ=3.5,σ=1.2)$，且限制在 [0,180] 范围内。
        
2. **目标入住日期 (Target Date, $T_{stay,i}$​)**
    - **定义**：消费者实际想要入住的那一天。
    - **计算公式**：
        $T_{stay,i}​=CurrentDate_t​+L_i​$
    - _逻辑意义_：这决定了该消费者是否会落入我们当前管理的房源时间窗口内。
        
3. **最高支付意愿 (Willingness To Pay, $WTP_i$​)**
    **定义**：消费者愿意支付的最高单夜房费。
    - **分布模型**：**正态分布 (Normal Distribution)**。
    - **参数来源**：基于 CSV 中的 `adr` 列，按月份统计均值和方差。
    - **差异化**：
        - $WTP_{TypeA}​∼N(μ_{adr}​×1.1,σ_{adr}​)$
        - $WTP_{TypeB}​∼N(μ_{adr}​×0.95,σ_{adr}​)$
    - **约束**：$WTP_i​=max(WTP_{min}​,WTP_i​)$，确保不出现负值或不合理的极低值（例如设下限为10美元）。
        
4. **价格敏感度系数 (Price Sensitivity, $β_i$​)**
    - **定义**：消费者对价格变动的敏感程度（用于效用函数）。
    - **生成逻辑**：这是一个隐变量，数据中无法直接获得，需基于假设设定。
    - **关联性假设**：通常提前期越短（$L_i​$小），需求越刚性，敏感度越低；提前期越长（$L_i$​大），越容易比价，敏感度越高。
    - **公式**：
        $β_i​=β_{base}​+α⋅log(1+L_i​)+ϵ$
        - 或者简单起见，设定为服从均匀分布的随机变量：$β_i​∼U(0.8,1.2)$。

|**参数符号**|**含义**|**对应 CSV 列 / 处理方式**|
|---|---|---|
|$\lambda_{1} \dots \lambda_{12}$|1-12月各自的日均到达率|`arrival_date_month` (Group By count / days)|
|$\mu_{lead}, \sigma_{lead}$|提前期分布参数|`lead_time` (Fit Exponential or Gamma)|
|$\mu_{adr}, \sigma_{adr}$|支付意愿分布参数|`adr` (Mean & Std, filter is_canceled=0)|
## 1.3客户决策模块

基于上述公式，不同类型的消费者在面对**双渠道（直销 Pdir​ vs 分销 Pota​）**时采取不同的决策逻辑。

1. Type A：传统/忠诚客户 (Traditional)
此类客户**只关注直销渠道**。
- **输入**：直销价 Pdir​。
- **逻辑**：
    1. **效用计算**：
        $U_{dir}​=(WTP_i​−P_{dir}​)⋅β_i​+ \frac{\gamma}{L_i + 1} + ϵ$      
    2. **购买决策**：
        - **IF** $U_{dir}​>U_{threshold}$​ (通常设为 0):
            - **Booking(Direct)**
        - **ELSE**:
            - **Leave** (觉得不划算且不紧迫)

2. Type B：网络/比价客户 (Digital)

此类客户**同时关注双渠道**，追求效用最大化。
- **输入**：直销价 Pdir​，分销价 Pota​。
- **逻辑**：
    1. **效用计算**：
        - 直销效用：$U_{dir}​=(WTP_i​−P_{dir}​)⋅β_i​+ \frac{\gamma}{L_i​+1} +ϵ_1$​
        - 分销效用：$U_{ota}​=(WTP_i​−P_{ota}​)⋅β_i​+\frac{\gamma}{L_i​+1} ​+ϵ_2$
        >_注：可以给 Uota​ 额外增加一个常数 Chabit​ 代表渠道使用习惯带来的便利效用。(暂时不加)_
            
    2. **渠道博弈决策**：
        - 取最大效用：$U_{max}​=max(U_{dir}​,U_{ota}​)$
        - **IF** $U_{max}​>U_{threshold}$​:
            - **IF** $U_{ota​}≥U_{dir}$​:
                - **Booking(OTA)** (OTA 更划算或效用更高)
            - **ELSE**:                
                - **Booking(Direct)** (直销性价比反超)
        - **ELSE**
            - **Leave**

|**参数符号**|**含义**|**建议设定 / 校准方法**|
|---|---|---|
|$\beta_i$|价格敏感度|建议设为 **1.0** (基准值)，或在 **[0.8, 1.2]** 间均匀分布。|
|$\gamma$|紧迫权重|建议设为 **5.0 ~ 10.0**。逻辑是：如果是当天订房 ($L=0$)，即使 $P=WTP$ (盈余为0)，紧迫效用也能贡献 5-10 分，抵消负向噪声。|
|$\sigma_{noise}$|噪声标准差|建议设为 **10.0 ~ 15.0**。这个值决定了决策的随机性。过大则RL难以学习，过小则环境太死板。|

## 1.3 购买结算

一旦发生预订行为，ABM 需立即执行以下操作，并记录数据以供 RL Agent 学习，维持180天库存。

1. 库存扣减 (LRA 协议)

- 无论 Booking(Direct) 还是 Booking(OTA)，均扣减同一目标日期的总库存：
    $Inventory(TargetDate)←Inventory(TargetDate)−1$
- **约束**：若库存降为 0，当日即刻停售（Stop Sell）。

2. 资金结算规则
ABM 将交易结果折算为 Reward 信号：
- **若成交为 Direct (直销)**：
    - **Hotel Reward**：$+P_{dir}$​
    - **OTA Reward**：0
        
- **若成交为 OTA (分销)**：
    - **Hotel Reward**：$+P_{base​}×(1−c\%)$
        - _注_：酒店按挂牌价扣佣结算，锁定收益。
    - **OTA Reward**：$+(P_{base}​×c\%)−Subsidy$
        - _注_：OTA 赚取佣金差价。若补贴过多导致 $Subsidy>Commission$，则此单 OTA 亏损。

## ~~1.3客户取消模块(废除取消模块)~~

~~一、核心定义~~
~~该模块在仿真的每一个时间步（每一天），遍历所有**“已预订但未入住”**的订单（Active Bookings），重新评估客户持有该订单的效用。~~

~~二、决策逻辑：持有还是放弃？~~
~~我们将客户决定“是否取消”的行为建模为对 “持有当前订单的净效用 (Uhold​)”的连续评估。~~
- ~~**输入**：~~
    - ~~订单特征：$P_{paid}$​ (成交价), WTP (原始支付意愿)。~~
    - ~~环境特征：d (距离入住的剩余天数), $P_{curr}$​ (酒店当前的公开报价)。~~
- ~~**触发机制**：每日检测。~~

~~三、数学模型：动态持有效用函数~~

~~客户 $i$ 在距离入住还有$d$ 天时的持有效用 $U_{hold,i}​(d)$ 定义如下：~~

~~$U_{hold,i}(d) = {(WTP_i - P_{paid})}_{\text{}} - {\beta \cdot \max(0, P_{paid} - P_{curr})}_{\text{}} + \frac{\gamma}{d + 1} + {\xi_t}_{\text{}}$~~

~~各项含义详解：~~
1. ~~**原始满意度 (Satisfaction)**：~~
    - ~~$(WTP_i​−P_{paid}​)$。~~
    - ~~逻辑：当初买的时候觉得越划算（盈余越大），现在越不愿意取消。这是订单的“基础稳定性”。~~
        
2. ~~**价格后悔 (Price Regret)**：~~
    - ~~$max(0,P_{paid}​−P_{curr}​)$~~
    - ~~逻辑：这是**动态定价**中最微妙的博弈。如果酒店今天降价了 ($P_{curr}​<P_{paid}​$)，老客户会觉得自己买贵了，从而产生负效用（想退单重订或去别家）。~~
    - ~~β：**后悔系数**。模拟客户对价格波动的敏感度。~~
        
3. ~~**临近承诺效应 (Commitment/Urgency)**：~~
    - ~~$\frac{\gamma}{1+d}$​~~
    - ~~逻辑：随着入住日临近 (d→0)，客户寻找替代酒店的成本变高，行程确定的沉没成本变大，因此取消的概率应随时间递减。~~
    - ~~$γ$：**承诺权重**。~~
    
4. ~~**每日随机冲击 (Daily Shock)**：~~
    - ~~$ξ_t​∼N(0,σ_{shock}​)$~~
    - ~~逻辑：模拟突发事件（生病、行程取消、被竞争对手挖墙脚）。这是导致取消的主要随机源。~~

~~四、决策规则~~

- ~~**计算**：每日计算一次 Uhold​。~~
- ~~**判定**：~~
    - ~~若 $U_{hold}​<0$ ⟹ **取消订单 (Cancel)**。库存释放，扣除（或全额）退款。~~
    - ~~若 $U_{hold}​≥0$ ⟹ **保留订单 (Keep)**。进入下一天继续评估。~~

| **参数**                       | **含义** | **数据来源 / 校准目标**                                                                                  |
| ---------------------------- | ------ | ------------------------------------------------------------------------------------------------ |
| **Global Cancellation Rate** | 全局取消率  | 数据显示约为 **37%** (`is_canceled` 均值)。我们需要调整 $\sigma_{shock}$，使得在平均提前期（104天）内，Agent 累计触发取消的概率接近 37%。 |
| **Lead Time Effect**         | 时间影响   | 数据中不同 `lead_time` 的取消率不同。通过 $\gamma$ (承诺权重) 来调整，确保临近入住时的取消率显著降低。                                 |
| **$\beta$(Regret)**          | 后悔系数   | 数据中无法直接体现，但这是 RL 训练的关键。建议设为 **0.5 ~ 1.0**。这意味着：如果酒店降价 100 元，客户的持有效用就下降 50~100 点，增加了取消风险。         |


# 2.强化学习部分

## 2.1 价格设计

本系统摒弃“OTA 跟随酒店每日报价”的逻辑，转而采用**“双轨制定价”**：

1. **基准价格 ($P_{base}$​)**：
    - **性质**：**静态、较高**。相当于酒店的“门市挂牌价 (Rack Rate)”**。
    - **来源**：基于 `hotel_bookings.csv` 历史数据统计出的**高分位值**（70% 分位数），在仿真开始前即确定，仿真过程中不随酒店每日决策波动。
    - **约束**：$P_{base}$​ 是 OTA 价格的**天花板**。

2. 远期价格 ($P_{long}$)
	- 性质：消费者若提前较长时间预订时的价格
	- 来源：基于 `hotel_bookings.csv` 历史数据统计出的平均数

3. **直销价格 ($P_{dir}$​)**：    
    - **性质**：**动态**。酒店 Agent 每日根据库存实时调整。
    - **逻辑**：通常低于挂牌价（Pdir​≤Pbase​）。
        
4. **分销价格 ($P_{ota}$​)**：
    - **性质**：**折价**。OTA Agent 在 $P_{base}$​ 基础上进行补贴/打折。
    - **逻辑**：$P_{ota}​=P_{base}​−Subsidy$。OTA 无法定出高于 $P_{base}$​ 的价格。
## 2.2 交易模式：佣金代理 + 补贴

- **资金流**：
    - **酒店收入**：按挂牌价锁定的结算额？不，佣金模式下通常按**实际成交价**或**协议底价**结算。
    - _修正设计_：为了符合“基准价提前确定”且“OTA 自掏腰包补贴”的逻辑，我们设定酒店与 OTA 的结算基数是 **$P_{base}$​**（即酒店视 OTA 渠道为销售挂牌价的渠道，佣金以此为基数）。
    - **酒店获得**：$P_{base}​×(1−c\%)$
        - _这意味着酒店在 OTA 渠道锁定了固定收益，风险完全转移给 OTA（如果 OTA 卖不掉）。这类似于“包销”的变体，但在逻辑上更通顺。_
            
    - **OTA 获得**：$(P_{base}​×c\%)−Subsidy$。
    - **消费者支付**：$P_{base}​−Subsidy$。
## 2.2基于离散化 Q-learning 的智能体设计

本章详细阐述双智能体（Hotel Agent & OTA Agent）在近场区（Day 0 - Day 14）的内部决策机制。为了适应 Q-learning 算法，我们将连续的环境变量（如库存率、价格比）进行了精细的离散化分桶（Binning）处理。

 ### 2.1.1酒店智能体 (Hotel Agent) —— 状态离散化设计

1. 状态空间设计 (Shotel​)

我们采用元组 (D,I,C,W,S) 来唯一标识一个状态，总状态数为 **1,080** 个。这个量级在普通笔记本上几分钟即可训练收敛。

| 状态维度       | 变量名           | 离散化规则 (Binning)                                                                                                                                               | 状态数    | 业务含义                                 |
| ---------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ | ------------------------------------ |
| **提前期**    | `days_ahead`  | 保持原始值：0,1,…,14                                                                                                                                                | **15** | 精确区分“最后1天”和“还有2周”的策略差异。              |
| **库存压力**   | `inv_level`   | **4档离散化**：<br>• **0 (空闲)**: Usage<30%<br>• **1 (正常)**: 30%≤Usage<60%<br>• **2 (紧张)**: 60%≤Usage<90%<br>• **3 (告急)**: Usage≥90%                                | **4**  | 核心信号。库存告急时（Level 3），Agent 应学会涨价。     |
| **OTA竞争力** | `comp_status` | **3档离散化** (基于 $Ratio=P_{ota\_last}​/P_{dir\_last}​$)：<br>• **0 (劣势)**: Ratio<0.98 (OTA便宜)<br>• **1 (均势)**: 0.98≤Ratio≤1.02<br>• **2 (优势)**: Ratio>1.02 (OTA贵) | **3**  | 竞争信号。若处于劣势（Level 0），直销渠道可能会被 OTA 截流。 |
| **周末标识**   | `is_weekend`  | **2档**：0 (周一至周四), 1 (周五至周日)                                                                                                                                   | **2**  | 捕捉周末的高支付意愿特征。                        |
| **季节热度**   | `season_type` | **3档** (基于 CSV 月份统计)：<br>• **0 (淡季)**: 1, 2, 11, 12月<br>• **1 (平季)**: 3, 4, 5, 6月<br>• **2 (旺季)**: 7, 8, 9, 10月                                               | **3**  | 宏观环境信号。                              |

- **状态空间总大小**：15×4×3×2×3=1,080 个状态。

2. 动作空间设计 ($A_{hotel}$​)
酒店决定**直销折扣**和**佣金档位**。
- **直销定价系数 ($β_{dir}$​)** —— 5档
    - `[0.80, 0.85, 0.90, 0.95, 1.00]`
    - _执行_：$P_{dir}​=P_{base}​×β_{dir}$​。
    - _含义_：酒店通常是在挂牌价基础上打折卖。
        
2. **佣金档位 (Tiercomm​)** —— 4档
    - `[0 (10%), 1 (15%), 2 (20%), 3(25%)]`
    - _执行_：确定结算比例 c。同时决定 ABM 中的**流量权重**。

3. 奖励函数 ($R_{hotel}$​)
$R_{hotel}​=(Sales_{direct}​×P_{dir​})+(Sales_{ota}​×P_{base}​×(1−c\%))$

- **关键博弈**：
    - OTA 渠道单笔收入固定为 $P_{base}​(1−c)$。
    - 直销渠道单笔收入为 $P_{dir}$​。
    - Agent 需权衡：如果 $P_{dir}$​ 定得比 $P_{base}​(1−c)$ 低，那还不如把房给 OTA 卖（如果 OTA 卖得动）；如果 $P_{dir}$​ 高，则直销更赚。

### 2.1.1 分销商智能体 (OTA Agent) —— 状态离散化设计

1. 状态空间设计 (Sota​)

OTA 关注的是“拿到手的货”好不好卖，以及“有没有套利空间”。

| 状态维度     | 变量名           | 离散化规则 (Binning)                                                                                                                                | 状态数    | 业务含义                                     |
| -------- | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- | ------ | ---------------------------------------- |
| **提前期**  | `days_ahead`  | 保持原始值：0,1,…,14                                                                                                                                 | **15** | 精确区分“最后1天”和“还有2周”的策略差异。                  |
| **库存压力** | `inv_level`   | **4档离散化**：<br>• **0 (空闲)**: Usage<30%<br>• **1 (正常)**: 30%≤Usage<60%<br>• **2 (紧张)**: 60%≤Usage<90%<br>• **3 (告急)**: Usage≥90%                 | **4**  | 核心信号。库存告急时（Level 3），Agent 应学会涨价。         |
| **套利空间** | `margin_room` | **3档离散化** (基于$M=P_{direct\_curr}​/P_{wholesale}​$)：<br>• **0 (微利)**: M<1.1 (直销价压得很低)<br>• **1 (正常)**: 1.1≤M<1.3<br>• **2 (暴利)**: M≥1.3 (直销价很高) | **3**  | 套利信号。如果是暴利（Level 2），OTA 可以定高价依然比官网便宜，躺赚。 |
| **周末标识** | `is_weekend`  | **2档**：0 (周一至周四), 1 (周五至周日)                                                                                                                    | **2**  | 捕捉周末的高支付意愿特征。                            |
| **季节热度** | `season_type` | **3档** (基于 CSV 月份统计)：<br>• **0 (淡季)**: 1, 2, 11, 12月<br>• **1 (平季)**: 3, 4, 5, 6月<br>• **2 (旺季)**: 7, 8, 9, 10月                                | **3**  | 宏观环境信号。                                  |
> 后续可以将周末标识和季节热度进行降维为市场热度

- **状态空间总大小**：15×4×3×2×3=1,080  个状态。

2. 动作空间设计 (Aota​)

OTA 决定**补贴力度（Subsidy Depth）**。
- **补贴系数 (δsub​)** —— 5档
    - `[0.0, 0.2, 0.4, 0.6, 0.8]`
    - _含义_：消耗**佣金收入**的百分比。
    - _执行_：
        1. **总佣金**：$Commission=P_{base+}×c\%$
        2. **补贴额**：$Subsidy=Commission×δ_{sub}$​
        3. **最终售价**：$P_{ota}​=P_{base}​−Subsidy$

3. 奖励函数 (Rota​)

$R_{ota}​=(Commission−Subsidy)×Sales_{ota}$​

